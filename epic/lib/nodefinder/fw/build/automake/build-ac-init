#! /bin/sh

#---------------------------------------------------------------------
#                           chicken and egg                           
#---------------------------------------------------------------------

test -f "${FW_ROOT}/share/fw/sh/fw-find.sh" && fws="${FW_ROOT}/share/fw/sh/fw-find.sh"
test -f "fw/sh/fw-find.sh" && fws="fw/sh/fw-find.sh"
test -f "fw.local/sh/fw-find.sh" && fws="fw.local/sh/fw-find.sh"
test ! -z "$fws" || {
  echo "build/automake/build-ac-init: fatal: can't locate fw-find.sh" 1>&2
  exit 1
}

. "$fws"

#---------------------------------------------------------------------
#                              routines                               
#---------------------------------------------------------------------

fw_source "build/automake/build-ac-init" "sh/fw-exec.sh"

#---------------------------------------------------------------------
#                                main                                 
#---------------------------------------------------------------------

test -z "${FW_TRACE}" || set -x

template="$1"
shift
acargs="$1"
shift

eval `fw_exec "template/$template/load-config" "$@"`

test ! -e ac-init.generated || chmod +w ac-init.generated || exit 1

cat <<EOD > ac-init.generated
dnl -- This file is autogenerated, do not edit!
dnl -- Instead edit fw-pkgin/config
AC_INIT([$FW_PACKAGE_NAME], [$FW_PACKAGE_VERSION], [$FW_PACKAGE_MAINTAINER])

if test -d bin
  then
    PATH="\`pwd\`/bin:\$PATH"
    export PATH
  fi

if test -d fw/bin
  then
    PATH="\`pwd\`/fw/bin:\$PATH"
    export PATH
  fi

which fw-exec >/dev/null 2>/dev/null

test \$? = 0 || {
  AC_MSG_ERROR([can't load config])
  exit 1
}

eval \`fw-exec "template/$template/load-config" $@\`

FW_SUBST_PROTECT(FW_PACKAGE_NAME)
FW_SUBST_PROTECT(FW_PACKAGE_VERSION)
FW_SUBST_PROTECT(FW_PACKAGE_MAINTAINER)
FW_SUBST_PROTECT(FW_PACKAGE_SHORT_DESCRIPTION)
FW_SUBST_PROTECT(FW_PACKAGE_DESCRIPTION)
FW_SUBST_PROTECT(FW_PACKAGE_ARCHITECTURE_DEPENDENT)
FW_SUBST_PROTECT(FW_PACKAGE_DEPENDS)
FW_SUBST_PROTECT(FW_PACKAGE_CONFLICTS)
FW_SUBST_PROTECT(FW_PACKAGE_PROVIDES)
FW_SUBST_PROTECT(FW_PACKAGE_BUILD_DEPENDS)
FW_SUBST_PROTECT(FW_PACKAGE_BUILD_CONFLICTS)

FW_TEMPLATE="$template"
FW_SUBST_PROTECT(FW_TEMPLATE)

FW_ACLOCAL_ARGS="$acargs"
FW_SUBST_PROTECT(FW_ACLOCAL_ARGS)

AC_PREFIX_DEFAULT("/usr")
EOD

chmod -w ac-init.generated || exit 1
